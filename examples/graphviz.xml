<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25" zv="Cache for Windows (x86-64) 2014.1.1 (Build 702U)" ts="2014-08-05 12:14:10">
<Class name="CNA.Examples.GraphViz">
<Super>%RegisteredObject</Super>

<Property name="gvc">
<Type>%String</Type>
<Private>1</Private>
</Property>

<Property name="cgraph">
<Type>%String</Type>
<Private>1</Private>
</Property>

<Method name="%OnNew">
<FormalSpec>CNAPath:%String,gvcPath:%String,cgraphPath:%String</FormalSpec>
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	try {
		if (('$data(CNAPath)) || ('##class(%File).Exists(CNAPath))) {
			return $$$ERROR("CNA file doesn't exists")	
		}
		if (('$data(gvcPath)) || ('##class(%File).Exists(gvcPath))) {
			return $$$ERROR("gvc file doesn't exists")	
		}
		if (('$data(cgraphPath)) || ('##class(%File).Exists(cgraphPath))) {
			return $$$ERROR("cgraph file doesn't exists")	
		}
		
		set ..gvc = ##class(CNA.CNA).%New(CNAPath)
		set ..cgraph = ##class(CNA.CNA).%New(CNAPath)

		do ..gvc.LoadLibrary(gvcPath)
		do ..cgraph.LoadLibrary(cgraphPath)
	} catch ex {
		do ex.Log()
		return ex.AsStatus()
	}
	
	Quit $$$OK
]]></Implementation>
</Method>

<Method name="%OnClose">
<Private>1</Private>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	try {
		do ..gvc.FreeLibrary()
		do ..cgraph.FreeLibrary()
	} catch ex {
		do ex.Log()
		return ex.AsStatus()
	}
	Quit $$$OK
]]></Implementation>
</Method>


<Method name="DrawRing">
<FormalSpec>path:%String</FormalSpec>
<Implementation><![CDATA[
	try {
		set colors = "red,green,blue,black,gold,cyan,magenta,yellow,coral,indigo,grey,crimson"

		set argTypes = ##class(%ListOfDataTypes).%New()
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#UCHAR)
		do argTypes.Insert(..cgraph.#POINTER)
		set name = ..cgraph.ConvertStringToPointer("CNA graph")
		set graph = ..cgraph.CallFunction("agopen", ..cgraph.#POINTER, argTypes, name, 9, ..cgraph.NULL)
		w graph, !

		do argTypes.Clear()
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#INT)
		set name = ..cgraph.ConvertStringToPointer("0")
		set startNode = ..cgraph.CallFunction("agnode", ..cgraph.#POINTER, argTypes, graph, name, 1)
		w startNode, !

		do argTypes.Clear()
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#INT)
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#POINTER)
		set name = ..cgraph.ConvertStringToPointer("color")
		set color = ..cgraph.ConvertStringToPointer("black")
		do ..cgraph.CallFunction("agattr", ..cgraph.#POINTER, argTypes, graph, 2, name, color)

		set oldNode = startNode

		for i=1:1:11 {
			do argTypes.Clear()
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#INT)
			set name = ..cgraph.ConvertStringToPointer(i)
			set newNode = ..cgraph.CallFunction("agnode", ..cgraph.#POINTER, argTypes, graph, name, 1)

			do argTypes.Clear()
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#INT)
			set edge = ..cgraph.CallFunction("agedge", ..cgraph.#POINTER, argTypes, graph, oldNode, newNode, ..cgraph.NULL, 1)

			do argTypes.Clear()
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#POINTER)
			do argTypes.Insert(..cgraph.#POINTER)
			set name = ..cgraph.ConvertStringToPointer("color")
			set color = ..cgraph.ConvertStringToPointer($p(colors, ",", $r(12) + 1))
			do ..cgraph.CallFunction("agset", ..cgraph.#INT, argTypes, edge, name, color)

			set oldNode = newNode
		}

		do argTypes.Clear()
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#POINTER)
		do argTypes.Insert(..cgraph.#INT)
		set edge = ..cgraph.CallFunction("agedge", ..cgraph.#POINTER, argTypes, graph, oldNode, startNode, ..cgraph.NULL, 1)


		do argTypes.Clear()
		set gvc = ..gvc.CallFunction("gvContext", ..gvc.#POINTER, argTypes)
		w gvc, !
		do argTypes.Insert(..gvc.#POINTER)
		do argTypes.Insert(..gvc.#POINTER)
		do argTypes.Insert(..gvc.#POINTER)
		set layout = ..gvc.ConvertStringToPointer("neato")
		do ..gvc.CallFunction("gvLayout", ..gvc.#INT, argTypes, gvc, graph, layout)

		do argTypes.Insert(..gvc.#POINTER)
		set format = ..gvc.ConvertStringToPointer("svg")
		set file = ..gvc.ConvertStringToPointer(path)
		do ..gvc.CallFunction("gvRenderFilename", ..gvc.#INT, argTypes, gvc, graph, format, file)

		do argTypes.Clear()
		do argTypes.Insert(..gvc.#POINTER)
		do argTypes.Insert(..gvc.#POINTER)
		do ..gvc.CallFunction("gvFreeLayout", ..gvc.#INT, argTypes, gvc, graph)

		do argTypes.Clear()
		do argTypes.Insert(..gvc.#POINTER)
		do ..gvc.CallFunction("gvFreeContext", ..gvc.#INT, argTypes, gvc)
		do ..cgraph.CallFunction("agclose", ..cgraph.#INT, argTypes, graph)
	} catch ex {
		write $system.Status.GetErrorText(ex.AsStatus()),!
	}
]]></Implementation>
</Method>
</Class>
</Export>



